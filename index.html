<!DOCTYPE html>
<html lang="en">

<head>
  <!--meta content and open graph tags for social sharing see _includes/metal.html-->
  <title>Town of Forest City Web Viewer</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <!--fonts and jquery-->
  <link href='https://fonts.googleapis.com/css?family=Montserrat:400,700|Open+Sans:400italic,400,800,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Archivo+Narrow:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Archivo+Black' rel='stylesheet' type='text/css'>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <!--Font Awesome and Bootstrap CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet">
  <!--map plugins-->
  <!--Mapping via LeafletJS updated 03-13-2015 -->
  <!--link rel="stylesheet" href="assets/leaflet/leaflet.css" />
  <script src="assets/leaflet/leaflet.js"></script-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.css" integrity="sha256-ymZGho+WjeQQ2jvjHInYJd0h20DI6/AE0fYq+BGYXqY=" crossorigin="anonymous" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.js" integrity="sha256-aReBHzIjoMzKrp0H4XnxXIm0mwuNG/F+00pKDiFuLxI=" crossorigin="anonymous"></script>
  <!--Home Button ie Default Extent-->
  <link rel="stylesheet" href="assets/default-extent/leaflet.defaultextent.css" />
  <script src="assets/default-extent/leaflet.defaultextent.js"></script>
  <!--Easy Print -->
  <link rel="stylesheet" href="assets/easy-print/easyPrint.css" />
  <script src="assets/easy-print/leaflet.easyPrint.js"></script>
  <!--locate control from source -->
  <link rel="stylesheet" href="assets/control-locate/L.Control.Locate.min.css" />
  <script src="assets/control-locate/L.Control.Locate.min.js"></script>
  <!--Leaflet Hash via Mapbox CDN-->
  <script src='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-hash/v0.2.1/leaflet-hash.js'></script>
  <!--Google Custom Map -->
  <script src="https://maps.google.com/maps/api/js?v=3"></script>
  <!-- Leaflet Omnivore Plugin GeoJson KML Etc -->
  <script src='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.2.0/leaflet-omnivore.min.js'></script>
  <!-- leaflet search -->
  <link rel="stylesheet" href="assets/search/leaflet-search.min.css" />
  <script src="assets/search/leaflet-search.min.js"></script>
  <!-- Leaflet Easy button Updated Dec 2015-->
  <link rel="stylesheet" href="assets/easy-button/easy-button.css" />
  <script src="assets/easy-button/easy-button.js"></script>
  <!--Leaflet sidebar v1 aka menu -->
  <link rel="stylesheet" href="assets/sidebar/L.Control.Sidebar.css" />
  <script src="assets/sidebar/L.Control.Sidebar.js"></script>
  <!-- leaflet loading and leaflet-spin works with leaflet ajax and map tiles -->
  <link rel="stylesheet" href="assets/loading/Control.Loading.css" />
  <script src="assets/loading/Control.Loading.js"></script>
  <script src="assets/spin/spin.js"></script>
  <script src="assets/spin/leaflet.spin.js"></script>
  <script src="assets/google/google.js"></script>
  <script src="assets/google/gglegrey.js"></script>
  <!--Mapbox fullscreen standalone js added in ovrdc-toolbar-->
  <link href='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v0.0.4/leaflet.fullscreen.css' rel='stylesheet' />
  <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/Leaflet.fullscreen.min.js'></script>
  <!--Esri Leaflet Core for AGOL layers -->
  <script src="//cdn.jsdelivr.net/leaflet.esri/1.0.0/esri-leaflet.js"></script>
  <!--Leaflet Ajax -->
  <script type="text/javascript" src="assets/leaflet/leaflet.ajax.js"></script>
  <!--Leaflet PanelLayers -->
  <link rel="stylesheet" href="assets/panel/leaflet-panel-layers.css" />
  <script src="assets/panel/leaflet-panel-layers.js"></script>
  <!--OVRDC Custom Styles-->
  <link rel="stylesheet" href="assets/css/ovrdc-style.css" />
  <link rel="stylesheet" href="assets/css/modern-ui.css" />
  <!--script src='https://unpkg.com/leaflet.gridlayer.googlemutant@latest/Leaflet.GoogleMutant.js'></script-->
  <!--End Leaflet Plugins-->
  <!--End Map CSS and JS-->
  <!--end plugins-->
</head>

<style>
  * {
    font-family: "Open Sans", sans-serif;
  }
</style>



<body>
  <!-- GeoJson tile Scripts -->
  <script src="assets/geojson-tiles/geojson-vt-dev.js"></script>
  <script src="assets/geojson-tiles/L.CanvasTiles.js"></script>
  <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-pip/v0.1.0/leaflet-pip.min.js'></script>

  <div id='map'>
    <div id="sidebar">
      <h2 style="font-family:Archivo Black, sans-serif;">Town of Forest City</h2>
      <h3 style="font-family:Archivo Black, sans-serif;">Rutherford County, N.C.</h3>
      <h5 style="font-family:Archivo Black, sans-serif;">
      Address: 128 N Powell St. Forest City, N.C.<br>
      Phone: 828-247-4412<br>
      Fax: 570-319-1321<br>
      Hours: 8:00 A.M. â€“ 5:00 P.M., Monday through Friday<br>
      E-mail Address: drewharris@townofforestcity.com</span></h5>
      <hr />
      <strong>Use zoom controls to navigate the map. Pinch & zoom and double tap to zoom have been disabled.</strong>
      <hr />
      <em>The parcels shown are for informational purposes only. <br>Map data is only updated once or so per year.</em>

      <div>
        <hr />
        <button id="showTools" type="button" class="btn btn-default btn-xs btn-block">Show Map Tools Legend</button>
        <button id="hideTools" type="button" class="btn btn-default btn-xs btn-block" style="display:none;">Hide Map Tools Legend</button>
        <div class="toolLegend" style="display:none;">
          <hr />
          <div class="list-group" style="text-align:left;">
            <li class="list-group-item"><i class='fa fa-bars fa-fw fa-lg'></i> Open Sidebar</li>
            <li class="list-group-item"><i class='fa fa-exchange fa-fw fa-lg'></i> Toggle Address Search</li>
            <li class="list-group-item"><img src="images/fullscreen-img.png" style="padding:0 1px;width:22px;"></img> Fullscreen</li>
            <li class="list-group-item"> <i class='fa fa-globe fa-fw fa-lg'></i> Default Map Extent</li>
            <li class="list-group-item"><i class='fa fa-map-marker fa-fw fa-lg'></i> Show/Follow Your Location</li>
            <li class="list-group-item"><i class='fa fa-cogs fa-fw fa-lg'></i> Toggle Map Tools (Mobile Only)</li>
            <li class="list-group-item"><img src="images/layers-bl.png" style="padding:0 1px;width:22px;"></img> Toggle Map Layers</li>
          </div>
        </div>
        <hr />
      </div>
      <script>
      // toggle toolbar visible/invisible
        $("#showTools").click(function () {
          $(".toolLegend").toggle();
          $("#showTools").toggle();
          $("#hideTools").toggle();
        });
        $("#hideTools").click(function () {
          $(".toolLegend").toggle();
          $("#showTools").toggle();
          $("#hideTools").toggle();
        });
      </script>

      <h6><a href='http://townofforestcity.com' target='_blank' style='text-decoration:none;'>Town of Forest City</a> | Map data updated 6/2019.</h6>
    </div>
  </div>

<script>

var map = L.map('map', {
  zoomControl: false,
  minZoom: 10,
  touchZoom: false,
  zoomAnimationThreshold: 2,
  doubleClickZoom: false
}).setView([35.333210, -81.864198], 12);

// begin map tiles //

var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
});

var cdblight = L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png', {
  attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',
  subdomains: 'abcd',
  minZoom: 0,
  maxZoom: 20,
  maxNativeZoom: 18,
});

var cdbdark = L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/dark_all/{z}/{x}/{y}.png', {
  attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',
  subdomains: 'abcd',
  minZoom: 0,
  maxZoom: 20,
  maxNativeZoom: 18,
});

var thundertransport = L.tileLayer('https://tile.thunderforest.com/transport/{z}/{x}/{y}.png?apikey=7b04830d899e4a91be1e0a117371e288', {
  attribution: '&copy; <a href="http://www.opencyclemap.org">OpenCycleMap</a>, &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
  maxZoom: 19,
});

var esritopo = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
  attribution: 'Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ, TomTom, Intermap, iPC, USGS, FAO, NPS, NRCAN, GeoBase, Kadaster NL, Ordnance Survey, Esri Japan, METI, Esri China (Hong Kong), and the GIS User Community',
  maxZoom: 20,
  maxNativeZoom: 18,
});

var ortho = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
  attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
  maxZoom: 18,
  maxNativeZoom: 17
});

var basemaps = [
  {
    active: false,
    name: "Open Street Map",
    layer: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png')
  },
  {
    active: true,
    name: "Satellite",
    layer: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}')
  }
];
// end map tiles //

// baselayer styling //
var muniStyle = {
  "color": '#000000',
  "weight": 3,
  "opacity": 1,
  "dashArray": 3,
  fillOpacity: 0
};
var floodplainStyle = {
  "color": "#178eef",
  "weight": 2,
  "opacity": 0.65,
  fillOpacity: 0.5,
  fillColor: '#abd3f4'
};
//end styling //

// baselayer container //
var baselayers = [
  {
    active: false,
    name: "Zoning",
    layer: new L.GeoJSON.AJAX("data/zoning.geojson", {
      style: function(feature) {
        return {
          weight: 1,
          opacity: 1,
          color: 'none',
          fillOpacity: getZoneOpacity(feature.properties.BASE_DISTR),
          fillColor: getZoneColor(feature.properties.BASE_DISTR)
    };
    }
  , onEachFeature: onEachZoningFeature})
  }
  ,{
    active: false,
    name: "Floodplains",
    layer: new L.GeoJSON.AJAX("data/floodplains.geojson", {style: floodplainStyle})
  }
  ,{
    active: false,
    name: "Municipal Boundary",
    layer: new L.GeoJSON.AJAX("data/muni.geojson", {style: muniStyle})
  }
];

var layerControl = new L.Control.PanelLayers(basemaps, baselayers);
map.addControl(layerControl);

// baselayer functions //
function onEachZoningFeature(feature, layer) {
  if (feature.properties && feature.properties.BASE_DISTR) {
     layer.bindPopup(feature.properties.BASE_DISTR);
   }
}



function getZoneOpacity(zone)
  {
  return zone == 'RU' ? 0
                 : .7;
               }

function getZoneColor(zone)
  {
    return zone == 'C-1' ? '#fccde5'
    : zone == 'C-2' ? '#FDB462'
    : zone == 'C-3' ? '#fb8072'
    : zone == 'M-1' ? '#d9d9d9'
    : zone == 'OI' ? '#80b1d3'
    : zone == 'R-6' ? '#ffed6f'
    : zone == 'R-8' ? '#ffed6f'
    : zone == 'R-15' ? '#ccebc5'
    : zone == 'R-20' ? '#b3de69'
    : zone == 'PRD' ? '#bc80bd' : '#fff';
  }

//--show google imagery at higher zoom levels (removed - no API)
// map.on('zoomend', function() {
//  if (map.getZoom() > 18 && map.hasLayer(ortho)) {
//    map.removeLayer(ortho);
//    map.addLayer(ggle);
//  }
  //  if (map.getZoom() < 19 && map.hasLayer(ggle)) {
//    map.removeLayer(ggle);
//    map.addLayer(ortho);
//  }
// });
  // map.on('baselayerchange', function() {
  //  if (map.getZoom() > 18 && map.hasLayer(ggle)) {
  //    map.removeLayer(ggle);
  //  }
  // });





console.log('start map toolbar');
//OVRDC Modern UI Toolbar
//OVRDC New marker
var ovrdcMarker = L.icon({
  iconUrl: 'assets/images/ovrdc-marker.png',
  //shadowUrl: 'leaf-shadow.png',
  iconSize: [48, 48], // size of the icon
  //shadowSize:   [50, 64], // size of the shadow
  iconAnchor: [24, 42], // point of the icon which will correspond to marker's location - half the width and height of icon
  //shadowAnchor: [4, 62],  // the same for the shadow
  popupAnchor: [0, -42] // point from which the popup should open relative to the iconAnchor
});
//end marker

var sidebar = L.control.sidebar('sidebar', {
  autoPan: false,
  closeButton: false
});
sidebar.addTo(map);

//Leaflet Search with OSM Geocode
var osmsearch = new L.Control.Search({
  url: 'https://nominatim.openstreetmap.org/search?format=json&q={s}',
  jsonpParam: 'json_callback',
  propertyName: 'display_name',
  propertyLoc: ['lat', 'lon'],
  circleLocation: false,
  autoType: false,
  autoCollapse: false,
  minLength: 2,
  zoom: 15,
  textPlaceholder: 'Search Addresses',
  collapsed: false
});
osmsearch.addTo(map);
var circle;
var marker;
osmsearch.on('search_locationfound', function(e) {
  if (marker) {
    map.removeLayer(marker);
  }
  var name = e.display_name;
  marker = new L.marker([e.latlng.lat, e.latlng.lng], {
    icon: ovrdcMarker
  }).addTo(map);
});

//Toggle OSM Search and Feature Search - remove if no feature search
var hash = L.hash(map);
var gpsLocate = L.control.locate({
  follow: true,
  locateOptions: {
    enableHighAccuracy: true
  }
});
//gpsLocate.addTo(map);
var homeExtent = L.control.defaultExtent({});
//homeExtent.addTo(map);
var fullscreen = L.control.fullscreen();

var globalsearchToggle = new L.easyButton({
  states: [{
    stateName: 'show',
    icon: 'fa-exchange fa-lg',
    title: 'Search Addresses',
    onClick: function(btn, map) {
      osmsearch.addTo(map);
      btn.state('hide');
    }
  }, {
    stateName: 'hide',
    icon: 'fa-exchange fa-border fa-lg',
    title: 'Search Features',
    onClick: function(btn, map) {
      map.removeControl(osmsearch);
      btn.state('show');
    }
  }]
});


    var loading = L.Control.loading({
      position: 'topright'
    }).addTo(map);
    var sidebarToggle = L.easyButton({
      states: [{
        stateName: 'open-sidebar', // name the state
        icon: 'fa-bars fa-lg', // and define it's properties
        title: 'Show Sidebar', // like it's title
        onClick: function(btn, map) { // and it's callback
          sidebar.show();
          btn.state('close-sidebar'); // change state on click!
        }
      }, {
        stateName: 'close-sidebar',
        icon: 'fa-times fa-2x',
        title: 'Hide Sidebar',
        onClick: function(btn, map) {
          sidebar.hide();
          btn.state('open-sidebar');
        }
      }],
      id: 'menu',
    });
    var stogglebar = L.easyBar([sidebarToggle], {
      id: 'toggle'
    }).addTo(map);
    var leafletprint = L.easyPrint();
    //end toolbar
    sidebar.on('hide', function() {
      sidebarToggle.state('open-sidebar');
    });
    sidebar.on('show', function() {
      sidebarToggle.state('close-sidebar');
    });
    //mobile toolbar menu
    //--tools toggle on small screens
    var toolshidden = false;
    var mobilescreen = false;
    var tools = L.easyButton({
      states: [{
        stateName: 'show-tools', // name the state
        icon: 'fa-cogs fa-lg', // and define it's properties
        title: 'Show Map Tools', // like it's title
        onClick: function(btn, map) { // and it's callback
          leafletprint.addTo(map);
          gpsLocate.addTo(map);
          homeExtent.addTo(map);
          fullscreen.addTo(map);

          globalsearchToggle.addTo(map);

          btn.state('hide-tools'); // change state on click!
          toolshidden = false;
          //console.log(toolshidden + ' state changed to hideTools');
        }
      }, {
        stateName: 'hide-tools',
        icon: 'fa-cogs fa-border fa-lg',
        title: 'Hide Map Tools',
        onClick: function(btn, map) {
          map.removeControl(leafletprint);
          map.removeControl(gpsLocate);
          map.removeControl(homeExtent);
          map.removeControl(fullscreen);

          map.removeControl(globalsearchToggle);

          btn.state('show-tools');
          toolshidden = true;
          //console.log(toolshidden+ ' state changed to showTools');
        }
      }],
      id: 'tools',
    });
    console.log('tools loaded');
    var w = window.innerWidth;
    console.log('screen width: ' + w);
    if (w < 481) {
      tools.addTo(map);
      toolshidden = true;
      mobilescreen = true;
    } else {
      leafletprint.addTo(map);
      gpsLocate.addTo(map);
      homeExtent.addTo(map);
      fullscreen.addTo(map);
      globalsearchToggle.addTo(map);
      toolshidden = false;
    }
    window.onresize = function() {
      if (toolshidden === true && window.innerWidth > 480 && mobilescreen === true) {
        leafletprint.addTo(map);
        gpsLocate.addTo(map);
        homeExtent.addTo(map);
        fullscreen.addTo(map);
        globalsearchToggle.addTo(map);
        map.removeControl(tools);
        toolshidden = false;
        mobilescreen = false;
      } else if (toolshidden === false && mobilescreen === true && window.innerWidth > 481) {
        tools.state('show-tools');
        mobilescreen = false;
        map.removeControl(tools);
      } else if (toolshidden === false && window.innerWidth < 481 && mobilescreen === false) {
        map.removeControl(leafletprint);
        map.removeControl(gpsLocate);
        map.removeControl(homeExtent);
        map.removeControl(fullscreen);
        map.removeControl(globalsearchToggle);
        tools.addTo(map);
        toolshidden = true;
        mobilescreen = true;
      } else {}
    };

map.on('baselayerchange', function () {
  if (L.Browser.mobile) {
    map.on('baselayerchange', function () {
      setTimeout(function () {
        $(".leaflet-control-layers").removeClass("leaflet-control-layers-expanded");
      }, 5000);
    });
  }
});

// end tools toggle and modern UI toolbar  //

var customZoom = L.control.zoom({
  position: 'topright'
}).addTo(map);
ortho.addTo(map);

// add parcels with omnivore //
var parcels = L.geoJson();
var tileData = omnivore.topojson("./data/parcels.json", null, parcels);
var search;

tileData.on('ready', function() {
  console.log('parcel data ready');
  map.fitBounds(parcels.getBounds());
  $(".blank").fadeOut();
  map.spin(false);
  setTimeout(function() {
    sidebar.show()
  }, 700);
  //initiate search after parcel data has loaded
  search = new L.Control.Search({
    layer: parcels,
    propertyName: 'index',
    initial: false,
    zoom: 18,
    collapsed: false,
    textPlaceholder: 'PIN or Owner',
    minLength: 3
  }).addTo(map);
  search.on('search_locationfound', function(e) {
    search.collapse();
    setTimeout(function() {
      map.fire('click', {
        latlng: e.latlng
      });
    }, 200);
  });
  //--end search--//
  //--start geojson-vt map tiles--//
  //--interaction on the underlying polygon not drawn but represented by the tiles - they draw better--//
  //--end search--//
  //--start geojson-vt map tiles--//
  //--interaction on the underlying polygon not drawn but represented by the tiles - they draw better--//
  var highlight;
  map.on('click', function(e) {
    if (highlight) {
      map.removeLayer(highlight)
    }
    var x = e.latlng.lng;
    var y = e.latlng.lat;
    var layerData = leafletPip.pointInLayer([x, y], parcels, true);
    if (!layerData[0]) {
      console.log('nothing to see here')
    } else {
      map.spin(true);
      var highlightIndex = layerData[0].feature.properties.index;
      highlight = new L.geoJson(data, {
        filter: function(feature, layer) {
          return feature.properties.index == highlightIndex
        },
        style: {
          color: 'deepskyblue',
          fillColor: 'deepskyblue'
        }
      }).addTo(map);
      var attributes = highlightIndex.split(' | ', 3);
      //--adjust here if you have more than two fields in your index field or someone can write a code that just lists them all--//
      var pin = attributes[0];
      var po = attributes[1];
      var addr = attributes [2];
      var popup = 'PIN: ' + pin + '<hr>Property Owner: ' + po + '<hr>Address: ' + addr;
      map.on('popupopen', function() {
        map.spin(false)
      });
      map.openPopup(popup, e.latlng);
      map.on('popupclose', function() {
        map.removeLayer(highlight)
      });
    }
  });
  //end point in polygon
  //geojson-vt
  var tileOptions = {
    maxZoom: 20, // max zoom to preserve detail on
    tolerance: 7, // 5 simplification tolerance (higher means simpler)
    extent: 4096, //4096, // 4096 tile extent (both width and height)
    buffer: 64, // 64 default 64tile buffer on each side
    debug: 0, // logging level (0 to disable, 1 or 2)
    indexMaxZoom: 0, // 0 max zoom in the initial tile index
    indexMaxPoints: 100000, // 100000 max number of points per tile in the index
  };
  var data = parcels.toGeoJSON();

  var tileIndex = geojsonvt(data, tileOptions);
  //take json output from geojson-vt and draw it with the now depricated (in leaflet-beta) L.canvasTiles and code from here - http://blog.sumbera.com/2015/05/31/geojson-vt-on-leaflet/
  var tileLayer = L.canvasTiles().params({
    debug: false,
    padding: 50
  }).drawing(drawingOnCanvas);
  var pad = 0;
  tileLayer.addTo(map);
  tileLayer.setZIndex(10);

  function drawingOnCanvas(canvasOverlay, params) {

    var bounds = params.bounds;
    params.tilePoint.z = params.zoom;

    var ctx = params.canvas.getContext('2d');
    ctx.globalCompositeOperation = 'source-over';


    //console.log('getting tile z' + params.tilePoint.z + '-' + params.tilePoint.x + '-' + params.tilePoint.y);

    var tile = tileIndex.getTile(params.tilePoint.z, params.tilePoint.x, params.tilePoint.y);
    if (!tile) {
      //console.log('tile empty');
      return;
    }

    ctx.clearRect(0, 0, params.canvas.width, params.canvas.height);

    var features = tile.features;

    ctx.strokeStyle = 'orange';


    for (var i = 0; i < features.length; i++) {
      var feature = features[i],
        type = feature.type;

      ctx.fillStyle = feature.tags.color ? feature.tags.color : 'transparent';
      ctx.beginPath();

      for (var j = 0; j < feature.geometry.length; j++) {
        var geom = feature.geometry[j];

        if (type === 1) {
          ctx.arc(geom[0] * ratio + pad, geom[1] * ratio + pad, 2, 0, 2 * Math.PI, false);
          continue;
        }

        for (var k = 0; k < geom.length; k++) {
          var p = geom[k];
          var extent = 4096;

          var x = p[0] / extent * 256;
          var y = p[1] / extent * 256;
          if (k) ctx.lineTo(x + pad, y + pad);
          else ctx.moveTo(x + pad, y + pad);
        }
      }

      if (type === 3 || type === 1) ctx.fill();
      ctx.stroke();
    }

  };

  });
  //--flood--//
  // add local data //

  /*//--Popup is too slow to respond plus the layer is labeled--//
  nfhl.bindPopup(function (error, featureCollection) {
  if(error || featureCollection.features.length === 0) {
  return false;
  } else {
  return featureCollection.features[0].properties.FLD_ZONE;
  }
  });
  */

  //--end--//
  map.on('overlayadd', function() {
  if(map.getZoom() < 14) {
  map.setZoomAround(map.getCenter(), 14);
  }
  $("#mapLegend").html("<img src='data/nfhl.png' alt='legend' style='width:100%;border:lightgray solid thin;padding:10px;margin-bottom: 10px;'/>");
  });
  map.on('overlayremove', function() {
  $("#mapLegend").html("");
  });


</script>
</body>
</html>
